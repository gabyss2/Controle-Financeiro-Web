
import React from "react"; import { View, Text, Alert, FlatList } from "react-native"; import { supabase } from "../lib/supabase"; import type { Card, CardPurchase } from "../types"; import { currency } from "../lib/utils";
export default function FaturaView() { const [cards, setCards] = React.useState<Card[]>([]); const [selectedCardId, setSelectedCardId] = React.useState<string | undefined>(); const [monthRef, setMonthRef] = React.useState(new Date(new Date().getFullYear(), new Date().getMonth(), 1).toISOString().slice(0,10)); const [items, setItems] = React.useState<CardPurchase[]>([]); const [total, setTotal] = React.useState(0);
  async function loadCards() { const { data, error } = await supabase.from('cards').select('*').order('alias'); if (error) Alert.alert('Erro', error.message); else setCards((data ?? []) as Card[]); }
  async function loadFatura() { if (!selectedCardId) return; const { data, error } = await supabase.from('card_purchases').select('*').eq('card_id', selectedCardId).eq('invoice_month', monthRef).order('installment_number', { ascending: true }); if (error) { Alert.alert('Erro', error.message); return; } const arr = (data ?? []) as CardPurchase[]; setItems(arr); setTotal(arr.reduce((acc, it) => acc + Number(it.amount || 0), 0)); }
  React.useEffect(() => { loadCards(); }, []); React.useEffect(() => { loadFatura(); }, [selectedCardId, monthRef]);
  return (<View style={{ gap: 8 }}><Text style={{ fontWeight: '700' }}>Fatura do mês</Text><Text>Mês de referência (YYYY-MM-01): {monthRef}</Text><Text style={{ opacity: 0.6 }}>(em breve coloco seletor de mês aqui)</Text><Text>Cartão selecionado: {selectedCardId ? (cards.find(c=>c.id===selectedCardId)?.alias) : '—'}</Text><View style={{ flexDirection:'row', flexWrap:'wrap', gap:8 }}>{cards.map(c => (<Text key={c.id} style={{ padding:8, borderWidth:1, borderRadius:8, marginRight:8 }} onPress={()=>setSelectedCardId(c.id)}>{c.alias}</Text>))}</View><Text style={{ marginTop: 8, fontWeight: '700' }}>Total: {currency(total)}</Text><FlatList data={items} keyExtractor={(i) => i.id} renderItem={({ item }) => (<View style={{ padding:10, borderWidth:1, borderRadius:8, marginTop:6 }}><Text>{item.description} — {currency(Number(item.amount))} ({item.installment_number}/{item.installments_total})</Text><Text style={{ opacity:0.6 }}>Responsável: {item.responsible} • Compra: {item.purchase_date}</Text></View>)} /></View>);
}


import React from "react"; import { View, Text, TextInput, Alert } from "react-native"; import { supabase } from "../lib/supabase"; import type { Card, Category } from "../types"; import { Button } from "./UI"; import { computeFirstInvoiceMonth, generateInstallmentMonths } from "../lib/cards";
export default function PurchaseForm() { const [cards, setCards] = React.useState<Card[]>([]); const [cats, setCats] = React.useState<Category[]>([]); const [description, setDescription] = React.useState(""); const [amount, setAmount] = React.useState(""); const [date, setDate] = React.useState(new Date().toISOString().slice(0,10)); const [installments, setInstallments] = React.useState("1"); const [cardId, setCardId] = React.useState<string | undefined>(); const [categoryId, setCategoryId] = React.useState<string | undefined>(); const [responsible, setResponsible] = React.useState<'Gabriela'|'Caue'|'Ambos'>('Gabriela'); async function load() { const { data: dc } = await supabase.from('cards').select('*').order('alias'); const { data: cg } = await supabase.from('categories').select('*').order('name'); setCards((dc ?? []) as Card[]); setCats((cg ?? []) as Category[]); } React.useEffect(() => { load(); }, []);
  async function submit() { try { if (!description.trim()) throw new Error('Descrição é obrigatória'); if (!amount) throw new Error('Valor é obrigatório'); if (!cardId) throw new Error('Selecione um cartão'); const card = cards.find(c => c.id === cardId); if (!card) throw new Error('Cartão inválido'); const value = parseFloat(String(amount).replace(',', '.')); const total = Math.max(1, parseInt(installments || '1')); const purchaseDate = new Date(date); const firstInvoice = computeFirstInvoiceMonth(purchaseDate, card.closing_day); const months = generateInstallmentMonths(firstInvoice, total); const rows = months.map((m, idx) => ({ card_id: card.id, description: description.trim(), category_id: categoryId ?? null, amount: value, purchase_date: purchaseDate.toISOString().slice(0,10), installments_total: total, installment_number: idx + 1, responsible, invoice_month: new Date(m.getFullYear(), m.getMonth(), 1).toISOString().slice(0,10) })); const { error } = await supabase.from('card_purchases').insert(rows); if (error) throw error; Alert.alert('Pronto!', 'Compra lançada com sucesso.'); setDescription(''); setAmount(''); setInstallments('1'); setCategoryId(undefined); } catch (e:any) { Alert.alert('Erro', e.message ?? 'Falha ao lançar compra'); } }
  return (<View style={{ gap: 8 }}><Text style={{ fontWeight: '700' }}>Nova compra (Cartão)</Text><TextInput placeholder="Descrição" value={description} onChangeText={setDescription} style={{ borderWidth:1, padding:10, borderRadius:8 }} /><TextInput placeholder="Valor" keyboardType="decimal-pad" value={amount} onChangeText={setAmount} style={{ borderWidth:1, padding:10, borderRadius:8 }} /><TextInput placeholder="Data da compra (YYYY-MM-DD)" value={date} onChangeText={setDate} style={{ borderWidth:1, padding:10, borderRadius:8 }} /><Text>Cartão: {cardId ? cards.find(c=>c.id===cardId)?.alias : '—'}</Text><View style={{ flexDirection:'row', flexWrap:'wrap', gap:8 }}>{cards.map(c => (<Button key={c.id} label={c.alias} onPress={()=>setCardId(c.id)} variant={cardId===c.id? 'primary':'ghost'} />))}</View><Text>Categoria: {categoryId ? cats.find(c=>c.id===categoryId)?.name : '—'}</Text><View style={{ flexDirection:'row', flexWrap:'wrap', gap:8 }}>{cats.filter(c=>c.type==='despesa' && !c.archived).map(c => (<Button key={c.id} label={c.name} onPress={()=>setCategoryId(c.id)} variant={categoryId===c.id? 'primary':'ghost'} />))}</View><Text>Responsável:</Text><View style={{ flexDirection:'row', gap:8 }}><Button label="Gabriela" onPress={()=>setResponsible('Gabriela')} variant={responsible==='Gabriela'?'primary':'ghost'} /><Button label="Cauê" onPress={()=>setResponsible('Caue')} variant={responsible==='Caue'?'primary':'ghost'} /><Button label="Ambos" onPress={()=>setResponsible('Ambos')} variant={responsible==='Ambos'?'primary':'ghost'} /></View><TextInput placeholder="Parcelas (ex.: 1, 2, 3...)" keyboardType="number-pad" value={installments} onChangeText={setInstallments} style={{ borderWidth:1, padding:10, borderRadius:8 }} /><Button label="Lançar compra" onPress={submit} /></View>);
}
